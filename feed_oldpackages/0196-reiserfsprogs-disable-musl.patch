From 1b26237bba733c113e96f3b8e92e44e42b1d2792 Mon Sep 17 00:00:00 2001
From: Dirk Neukirchen <dirkneukirchen@web.de>
Date: Sat, 27 Jun 2015 10:25:06 +0200
Subject: [PATCH 196/310] reiserfsprogs: disable musl

Signed-off-by: Dirk Neukirchen <dirkneukirchen@web.de>
---
 utils/reiserfsprogs/Makefile                       | 10 +++---
 .../patches/001-musl-fix_includes.patch            | 10 ++++++
 .../patches/002-musl-change_comp_fn_t.patch        | 38 ++++++++++++++++++++++
 3 files changed, 53 insertions(+), 5 deletions(-)
 create mode 100644 utils/reiserfsprogs/patches/001-musl-fix_includes.patch
 create mode 100644 utils/reiserfsprogs/patches/002-musl-change_comp_fn_t.patch

diff --git a/utils/reiserfsprogs/Makefile b/utils/reiserfsprogs/Makefile
index 9903a9f..39d8587 100644
--- a/utils/reiserfsprogs/Makefile
+++ b/utils/reiserfsprogs/Makefile
@@ -8,12 +8,12 @@
 include $(TOPDIR)/rules.mk
 
 PKG_NAME:=reiserfsprogs
-PKG_VERSION:=3.6.21
+PKG_VERSION:=3.6.24
 PKG_RELEASE:=1
 
-PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.gz
-PKG_SOURCE_URL:=@KERNEL/linux/utils/fs/reiserfs/
-PKG_MD5SUM:=bc00c7c4e047902575dc4e1c64ab3ba4
+PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.xz
+PKG_SOURCE_URL:=@KERNEL/linux/kernel/people/jeffm/$(PKG_NAME)/v$(PKG_VERSION)/
+PKG_MD5SUM:=66787380fb418ff7d88a23e47cda7af6
 
 PKG_FIXUP:=autoreconf
 PKG_INSTALL:=1
@@ -25,7 +25,7 @@ define Package/reiserfsprogs
   CATEGORY:=Utilities
   SUBMENU:=Filesystem
   TITLE:=ReiserFS filesystems utilities
-  DEPENDS:=+libuuid
+  DEPENDS:=+libuuid @!USE_MUSL
   URL:=http://www.namesys.com/
 endef
 
diff --git a/utils/reiserfsprogs/patches/001-musl-fix_includes.patch b/utils/reiserfsprogs/patches/001-musl-fix_includes.patch
new file mode 100644
index 0000000..75916ac
--- /dev/null
+++ b/utils/reiserfsprogs/patches/001-musl-fix_includes.patch
@@ -0,0 +1,10 @@
+--- a/include/misc.h
++++ b/include/misc.h
+@@ -4,6 +4,7 @@
+  */
+ 
+ /* nothing abount reiserfs here */
++#define _GNU_SOURCE
+ 
+ #ifndef REISERFSPROGS_MISC_H
+ #define REISERFSPROGS_MISC_H
diff --git a/utils/reiserfsprogs/patches/002-musl-change_comp_fn_t.patch b/utils/reiserfsprogs/patches/002-musl-change_comp_fn_t.patch
new file mode 100644
index 0000000..7bc878a
--- /dev/null
+++ b/utils/reiserfsprogs/patches/002-musl-change_comp_fn_t.patch
@@ -0,0 +1,38 @@
+# --- SDE-COPYRIGHT-NOTE-BEGIN ---
+# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
+#
+# Filename: package/.../dietlibc/patches/pkg_reiserfsprogs.patch
+# Copyright (C) 2006 The T2 SDE Project
+#
+# More information can be found in the files COPYING and README.
+#
+# This patch file is dual-licensed. It is available under the license the
+# patched project is licensed under, as long as it is an OpenSource license
+# as defined at http://www.opensource.org/ (e.g. BSD, X11) or under the terms
+# of the GNU General Public License as published by the Free Software
+# Foundation; either version 2 of the License, or (at your option) any later
+# version.
+# --- SDE-COPYRIGHT-NOTE-END ---
+
+--- ./include/misc.h.orig	2006-06-20 20:36:27.000000000 +0200
++++ ./include/misc.h	2006-06-20 20:36:48.000000000 +0200
+@@ -105,7 +105,7 @@
+ __u64 mask64 (int from, int count);
+ 
+ int reiserfs_bin_search (void * key, void * base, __u32 num, int width,
+-			 __u32 *ppos, __compar_fn_t comp_func);
++			 __u32 *ppos, int (*comp_func)(const void *, const void *));
+ 
+ struct block_handler {
+     __u32 blocknr;
+--- ./lib/misc.c.orig	2006-06-20 20:40:00.000000000 +0200
++++ ./lib/misc.c	2006-06-20 20:42:07.000000000 +0200
+@@ -604,7 +604,7 @@
+ /* this implements binary search in the array 'base' among 'num' elements each
+    of those is 'width' bytes long. 'comp_func' is used to compare keys */
+ int reiserfs_bin_search (void * key, void * base, __u32 num, int width,
+-			 __u32 * ppos, comparison_fn_t comp_func)
++			 __u32 * ppos, int (*comp_func)(const void *, const void *))
+ {
+     __u32 rbound, lbound, j;
+     int ret;
-- 
2.5.0

