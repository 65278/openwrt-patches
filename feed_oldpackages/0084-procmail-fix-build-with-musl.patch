From b859c2e5db447eea53fe891bd51453c87dbae673 Mon Sep 17 00:00:00 2001
From: Dirk Neukirchen <dirkneukirchen@web.de>
Date: Wed, 15 Apr 2015 16:49:13 +0200
Subject: [PATCH 084/310] procmail: fix build with musl

musl does not seem to have a libnsl

Signed-off-by: Dirk Neukirchen <dirkneukirchen@web.de>
---
 mail/procmail/Makefile                           |  3 ++-
 mail/procmail/patches/001-procmail_openwrt.patch | 14 ++++++--------
 mail/procmail/patches/100-rename_getline.patch   |  8 ++++----
 3 files changed, 12 insertions(+), 13 deletions(-)

diff --git a/mail/procmail/Makefile b/mail/procmail/Makefile
index c8beb4e..84c35fe 100644
--- a/mail/procmail/Makefile
+++ b/mail/procmail/Makefile
@@ -35,7 +35,8 @@ TARGET_CFLAGS += -DPROCMAIL
 define Build/Compile
 	$(MAKE) -C $(PKG_BUILD_DIR)/src -f ../Makefile.openwrt  \
 		$(TARGET_CONFIGURE_OPTS) \
-		CFLAGS="$(TARGET_CFLAGS)"
+		CFLAGS="$(TARGET_CFLAGS)" \
+		LDFLAGS="$(TARGET_LDFLAGS) $(if $(CONFIG_USE_MUSL),,-lnsl)"
 endef
 
 define Package/procmail/install
diff --git a/mail/procmail/patches/001-procmail_openwrt.patch b/mail/procmail/patches/001-procmail_openwrt.patch
index c33d826..12554f4 100644
--- a/mail/procmail/patches/001-procmail_openwrt.patch
+++ b/mail/procmail/patches/001-procmail_openwrt.patch
@@ -2,9 +2,8 @@ This patch is required to make procmail cross compile - it tries to run some aut
 obviously do not work in a cross compiled environment.
 
 
-diff -Naur procmail-3.22_orig/autoconf.h procmail-3.22/autoconf.h
---- procmail-3.22_orig/autoconf.h	1970-01-01 10:00:00.000000000 +1000
-+++ procmail-3.22/autoconf.h	2006-03-23 12:15:36.000000000 +1100
+--- /dev/null
++++ b/autoconf.h
 @@ -0,0 +1,21 @@
 +/* This file was automagically generated by autoconf */
 +
@@ -27,9 +26,8 @@ diff -Naur procmail-3.22_orig/autoconf.h procmail-3.22/autoconf.h
 +/* Hotwire LOCKINGTEST=100 */
 +/* Procmail will lock via: dotlocking, fcntl() */
 +/* autoconf completed */
-diff -Naur procmail-3.22_orig/Makefile.openwrt procmail-3.22/Makefile.openwrt
---- procmail-3.22_orig/Makefile.openwrt	1970-01-01 10:00:00.000000000 +1000
-+++ procmail-3.22/Makefile.openwrt	2006-03-23 12:15:36.000000000 +1100
+--- /dev/null
++++ b/Makefile.openwrt
 @@ -0,0 +1,18 @@
 +PM_OBJ=cstdio.o common.o exopen.o goodies.o locking.o \
 + mailfold.o foldinfo.o misc.o pipes.o regexp.o robust.o \
@@ -39,8 +37,8 @@ diff -Naur procmail-3.22_orig/Makefile.openwrt procmail-3.22/Makefile.openwrt
 +FM_OBJ=common.o fields.o formisc.o sublib.o ecommon.o \
 + acommon.o
 +
-+LDFLAGS = -lm -lnsl -ldl -lc
-+CFLAGS = -Os -DPROCMAIL
++LDFLAGS += -lm -ldl -lc
++CFLAGS += -Os -DPROCMAIL
 +
 +all: procmail formail
 +
diff --git a/mail/procmail/patches/100-rename_getline.patch b/mail/procmail/patches/100-rename_getline.patch
index 6cd359d..6cb872a 100644
--- a/mail/procmail/patches/100-rename_getline.patch
+++ b/mail/procmail/patches/100-rename_getline.patch
@@ -1,6 +1,6 @@
 --- a/src/fields.c
 +++ b/src/fields.c
-@@ -110,16 +110,16 @@
+@@ -110,16 +110,16 @@ void dispfield(p)register const struct f
  		    /* try and append one valid field to rdheader from stdin */
  int readhead P((void))
  { int idlen;
@@ -22,7 +22,7 @@
  	      continue;
 --- a/src/formail.c
 +++ b/src/formail.c
-@@ -819,7 +819,7 @@
+@@ -819,7 +819,7 @@ splitit:       { if(!lnl)   /* did the p
        { if(split)		       /* gobble up the next start separator */
  	 { buffilled=0;
  #ifdef sMAILBOX_SEPARATOR
@@ -33,7 +33,7 @@
  	      goto splitit;
 --- a/src/formisc.c
 +++ b/src/formisc.c
-@@ -115,7 +115,7 @@
+@@ -115,7 +115,7 @@ void loadchar(c)const int c;		      /* a
    buf[buffilled++]=c;
  }
  
@@ -44,7 +44,7 @@
       return EOF;					  /* spread the word */
 --- a/src/formisc.h
 +++ b/src/formisc.h
-@@ -17,4 +17,4 @@
+@@ -17,4 +17,4 @@ void
  char*
   skipwords P((char*start));
  int
-- 
2.5.0

